name: Update Contributor Registry

on:
  pull_request:
    types: [closed]

jobs:
  calculate:
    # Run on any merged PR (not just first-time contributors)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      lines_changed: ${{ steps.calc.outputs.lines_changed }}
    steps:
      - name: Verify GIST_PAT secret exists
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
        run: |
          if [ -z "$GIST_PAT" ]; then
            echo "❌ GIST_PAT secret is not configured"
            exit 1
          fi
          echo "✓ GIST_PAT is configured (length: ${#GIST_PAT} chars)"
      
      - name: Calculate lines changed
        id: calc
        run: |
          ADDITIONS=${{ github.event.pull_request.additions }}
          DELETIONS=${{ github.event.pull_request.deletions }}
          LINES_CHANGED=$((ADDITIONS + DELETIONS))
          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT

  update:
    needs: calculate
    uses: automation-workflows/contributor-automation/.github/workflows/reusable-update-registry.yml@main
    with:
      pr_number: ${{ github.event.pull_request.number }}
      repo_name: ${{ github.repository }}
      pr_author: ${{ github.event.pull_request.user.login }}
      lines_changed: ${{ fromJson(needs.calculate.outputs.lines_changed) }}
      pr_labels: ${{ toJson(github.event.pull_request.labels.*.name) }}
    secrets:
      GIST_PAT: ${{ secrets.GIST_PAT }}